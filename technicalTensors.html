<!-- Heavily based on https://github.com/jothepro/doxygen-awesome-css/blob/main/doxygen-custom/header.html -->
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <meta name="generator" content="Doxygen 1.9.8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- BEGIN opengraph metadata -->
    <meta property="og:title" content=libdl />
    <meta property="og:image" content="twemoji-brain.png" />
    <meta property="og:description" content="Simple yet powerful deep learning" />
    <meta property="og:url" content="https://github.com/TheMrSheldon/libdl" />
    <!-- END opengraph metadata -->
    <!-- BEGIN twitter metadata -->
    <meta name="twitter:image:src" content="twemoji-brain.png" />
    <meta name="twitter:title" content="libdl" />
    <meta name="twitter:description" content="Simple yet powerful deep learning" />
    <!-- END twitter metadata -->
    <title>libdl: Tensors</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <link rel="icon" type="image/svg+xml" href="twemoji-brain.png" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
    <script type="text/javascript" src="toggle-alternative-theme.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.init()
        DoxygenAwesomeTabs.init()
    </script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <!-- https://tholman.com/github-corners/ -->
    <a href="https://github.com/TheMrSheldon/libdl" class="github-corner" title="View source on GitHub" target="_blank"
        rel="noopener noreferrer">
        <svg viewBox="0 0 250 250" width="40" height="40"
            style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path
                d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path
                d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                fill="currentColor" class="octo-body"></path>
        </svg></a>
    <style>
        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out
        }
        @keyframes octocat-wave {
            0%,
            100% {
                transform: rotate(0)
            }
            20%,
            60% {
                transform: rotate(-25deg)
            }
            40%,
            80% {
                transform: rotate(10deg)
            }
        }
        @media (max-width:500px) {
            .github-corner:hover .octo-arm {
                animation: none
            }
            .github-corner .octo-arm {
                animation: octocat-wave 560ms ease-in-out
            }
        }
    </style>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
            <table cellspacing="0" cellpadding="0">
                <tbody>
                    <tr style="height: 56px;">
                        <td id="projectlogo"><img alt="Logo" src="twemoji-brain.png" /></td>
                        <td id="projectalign" style="padding-left: 0.5em;">
                            <div id="projectname">libdl
                                &#160;<span
                                    id="projectnumber">0.0.1</span>
                            </div>
                            <div id="projectbrief">Simple yet powerful deep learning</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('technicalTensors.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Tensors</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md20">Design Decisions</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="autotoc_md20"></a>
Design Decisions</h1>
<p>Tensors are at the heart of deep learning and one has to strike a good balance between performance, flexibility and ease of use when implementing them. In the context of C++, there are many design decisions going into how tensors could be implemented. For example:</p><ol type="1">
<li>Should a tensor interface be defined explicitly (e.g., via an abstract base class) or should tensors be defined as types that fulfill general concepts?</li>
<li>Who should own the tensor's memory? Should it be shared or uniquely owned?</li>
</ol>
<p>With respect to <em>1.</em>, we ultimately decided on an abstract base class for general pointer implementations, <code><a class="el" href="classdl_1_1TensorImpl.html">dl::TensorImpl</a></code>. And, to reduce the API's complexity, any concrete implementations of the base class are hidden behind device specific factories implementing <code><a class="el" href="classdl_1_1Device.html">dl::Device</a></code>. Some key points in favor if this implementation are:</p><ul>
<li>Ease of use &ndash; the user only has to deal with a single datatype, <code><a class="el" href="classdl_1_1TensorImpl.html">dl::TensorImpl</a></code> (or rather <code><a class="el" href="classdl_1_1TensorPtr.html" title="The Tensor is a managed pointer to a tensor. It can generally be thought of like an std::unique_ptr&lt;T...">dl::TensorPtr</a></code>) as outlined below. It is also semantically clear that all tensors are equal (no matter on which device they are stored)</li>
<li>Compile time &ndash; templating all operations on tensors and defining tensors as a concept (as opposed to a type) could certainly be clean but would also result in long compile times</li>
<li>Control and integration &ndash; we often need certain assumptions on the tensor operations to hold (e.g., about memory ownership). These may not be captured by concepts but can be expressed through API documentation and a common base class.</li>
</ul>
<p>The correct choice for <em>2.</em> was a lot more tricky but after initially going with unique ownership, tensors now share their memory. The key question behind this is, what behavior is natural for the user and efficient? For example consider the following code: </p><div class="fragment"><div class="line">dl::Tensor a = {1, 2, 3};</div>
<div class="line">dl::Tensor b = a;</div>
<div class="line">b[0] = 4;</div>
</div><!-- fragment --><p> which value should <code>a</code> hold? <em>Unique ownership</em> of memory would dictate that, since <code>b</code> cannot "co-own" the memory used by <code>a</code>, it must have created a copy of <code>a</code>'s memory and in the third line only the copy is modified such that <code>a</code> still holds the value <code>{1, 2, 3}</code> by the end. We don't always want for <code>b</code> to copy the members of <code>a</code>. For example, the return-type of the subscript operator (<code>[]</code>) can't be <code>dl::Tensor</code> since it must reference the memory of <code>a</code>. The best way to solve this, would be an additional datatype, <code>dl::TensorView</code>: </p><div class="fragment"><div class="line">dl::Tensor a = {1, 2, 3};</div>
<div class="line">dl::TensorView b = a;</div>
<div class="line">b[0] = 4;</div>
<div class="line"><span class="comment">// a is now {4, 2, 3}</span></div>
</div><!-- fragment --><p> With <em>shared ownership</em>, however, <code>dl::Tensor b = a;</code> could mean both: creating a copy of <code>a</code> (it is the "copy constructor" after all) or simply adding a reference to the memory that <code>a</code> references as well. For libdl, we chose <em>shared ownership</em> and solved this ambiguity problem by naming the datatyoe <code><a class="el" href="classdl_1_1TensorPtr.html" title="The Tensor is a managed pointer to a tensor. It can generally be thought of like an std::unique_ptr&lt;T...">dl::TensorPtr</a></code>, which could generally be thought of as a <code><a class="elRef" href="http://en.cppreference.com/w/cpp/memory/shared_ptr.html">std::shared_ptr</a>&lt;<a class="el" href="classdl_1_1TensorImpl.html">dl::TensorImpl</a>&gt;</code> with some tensor-specific API. It should now be clear that in </p><div class="fragment"><div class="line"><a class="code hl_class" href="classdl_1_1TensorPtr.html">dl::TensorPtr</a> a = {1, 2, 3};</div>
<div class="line"><a class="code hl_class" href="classdl_1_1TensorPtr.html">dl::TensorPtr</a> b = a;</div>
<div class="ttc" id="aclassdl_1_1TensorPtr_html"><div class="ttname"><a href="classdl_1_1TensorPtr.html">dl::TensorPtr</a></div><div class="ttdoc">The Tensor is a managed pointer to a tensor. It can generally be thought of like an std::unique_ptr&lt;T...</div><div class="ttdef"><b>Definition</b> <a href="tensorptr_8hpp_source.html#l00045">tensorptr.hpp:45</a></div></div>
</div><!-- fragment --><p> <code>b</code> is a (reference counted) pointer to the same memory that <code>a</code> also points to. The copy constructor copies the pointer and not the memory. There certainly are good points for both shared and unique ownership. Unique ownership for example (in the context of <code><a class="elRef" href="http://en.cppreference.com/w/cpp/memory/unique_ptr.html">std::unique_ptr</a></code> vs <code><a class="elRef" href="http://en.cppreference.com/w/cpp/memory/shared_ptr.html">std::shared_ptr</a></code>) is more performant since no atomic reference counter is needed and allows/forces the user of the API to think more about how they manage their memory. E.g., the user has control over if they want to copy or move memory. In practice, however, this also means that the exact same function must be overloaded differently depending on memory ownership: </p><div class="fragment"><div class="line">dl::Tensor matmul(dl::Tensor&amp; x, dl::Tensor&amp; y) {</div>
<div class="line">    <span class="comment">// *Reference* both tensors in the computation graph</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
<div class="line">dl::Tensor matmul(dl::Tensor&amp;&amp; x, dl::Tensor&amp; y) {</div>
<div class="line">    <span class="comment">// *Move* x into and **reference** y in the computation graph</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
<div class="line">dl::Tensor matmul(dl::Tensor&amp; x, dl::Tensor&amp;&amp; y) {</div>
<div class="line">    <span class="comment">// *Reference* x in and **move** y into the computation graph</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
<div class="line">dl::Tensor matmul(dl::Tensor&amp;&amp; x, dl::Tensor&amp;&amp; y) {</div>
<div class="line">    <span class="comment">// *Move* both tensors into the computation graph</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p> and we did not even mention that we also need to add overloads for <code>dl::TensorView</code> yet! Further consider the following case: </p><div class="fragment"><div class="line">{</div>
<div class="line">    dl::Tensor tmp = somefunc();</div>
<div class="line">    otherfunc(tmp, tmp);                        <span class="comment">// Option 1</span></div>
<div class="line">    otherfunc(<a class="code hl_functionRef" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(tmp), tmp);             <span class="comment">// Option 2</span></div>
<div class="line">    otherfunc(tmp, <a class="code hl_functionRef" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(tmp));             <span class="comment">// Option 3</span></div>
<div class="line">    otherfunc(<a class="code hl_functionRef" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(tmp), <a class="code hl_functionRef" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(tmp));  <span class="comment">// Option 4</span></div>
<div class="line">}</div>
<div class="ttc" id="amove_html"><div class="ttname"><a href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a></div><div class="ttdeci">T move(T... args)</div></div>
</div><!-- fragment --><p> Option 2 and 3 clearly don't work since <code>tmp</code> is used after it was moved away. Option 3 does not work since the first parameter causes the computation graph to hold a <em>reference</em> to <code>tmp</code>, which is moved away right after. Option 1 does work but is not ideal since it needs to unnecessarily copy the tensor. This problem could be avoided by something like </p><div class="fragment"><div class="line">{</div>
<div class="line">    dl::Tensor tmp = somefunc();</div>
<div class="line">    <span class="comment">// Move tmp into the computation graph and return a reference to it</span></div>
<div class="line">    dl::Tensor&amp; ref = dl::remember(<a class="code hl_functionRef" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(tmp));</div>
<div class="line">    otherfunc(ref, ref);</div>
<div class="line">}</div>
</div><!-- fragment --><p> but simplicity should be key here. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="technicalIdx.html">Technical</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
