<!-- Heavily based on https://github.com/jothepro/doxygen-awesome-css/blob/main/doxygen-custom/header.html -->
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <meta name="generator" content="Doxygen 1.9.8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- BEGIN opengraph metadata -->
    <meta property="og:title" content=libdl />
    <meta property="og:image" content="twemoji-brain.png" />
    <meta property="og:description" content="Simple yet powerful deep learning" />
    <meta property="og:url" content="https://github.com/TheMrSheldon/libdl" />
    <!-- END opengraph metadata -->
    <!-- BEGIN twitter metadata -->
    <meta name="twitter:image:src" content="twemoji-brain.png" />
    <meta name="twitter:title" content="libdl" />
    <meta name="twitter:description" content="Simple yet powerful deep learning" />
    <!-- END twitter metadata -->
    <title>libdl: Automatic Differentiation (Autodiff)</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <link rel="icon" type="image/svg+xml" href="twemoji-brain.png" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
    <script type="text/javascript" src="toggle-alternative-theme.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.init()
        DoxygenAwesomeTabs.init()
    </script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <!-- https://tholman.com/github-corners/ -->
    <a href="https://github.com/TheMrSheldon/libdl" class="github-corner" title="View source on GitHub" target="_blank"
        rel="noopener noreferrer">
        <svg viewBox="0 0 250 250" width="40" height="40"
            style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path
                d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path
                d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                fill="currentColor" class="octo-body"></path>
        </svg></a>
    <style>
        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out
        }
        @keyframes octocat-wave {
            0%,
            100% {
                transform: rotate(0)
            }
            20%,
            60% {
                transform: rotate(-25deg)
            }
            40%,
            80% {
                transform: rotate(10deg)
            }
        }
        @media (max-width:500px) {
            .github-corner:hover .octo-arm {
                animation: none
            }
            .github-corner .octo-arm {
                animation: octocat-wave 560ms ease-in-out
            }
        }
    </style>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
            <table cellspacing="0" cellpadding="0">
                <tbody>
                    <tr style="height: 56px;">
                        <td id="projectlogo"><img alt="Logo" src="twemoji-brain.png" /></td>
                        <td id="projectalign" style="padding-left: 0.5em;">
                            <div id="projectname">libdl
                                &#160;<span
                                    id="projectnumber">0.0.1</span>
                            </div>
                            <div id="projectbrief">Simple yet powerful deep learning</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('technicalAutodiff.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Automatic Differentiation (Autodiff)</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md10">How it works</a><ul><li class="level2"><a href="#autotoc_md11">Mathematical Background</a><ul><li class="level3"><a href="#autotoc_md12">Forward Mode</a></li>
<li class="level3"><a href="#autotoc_md13">Reverse Mode</a></li>
</ul>
</li>
<li class="level2"><a href="#autodiffimpl">Implementation in libdl</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md14">Adding Autodiff Support to a Function</a><ul><li class="level2"><a href="#autotoc_md15">Functions with Multiple Inputs</a></li>
<li class="level2"><a href="#autotoc_md16">Adding Autodiff to a Function that Composites autodiff enabled functions</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md17">Gradients</a><ul><li class="level2"><a href="#autotoc_md18">Gradients of Matrix Operations</a><ul><li class="level3"><a href="#autotoc_md19">Matrix Product</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>Optimization in the context of deep learning often means finding a local minimum of the loss function via some form of optimization routine, which usually needs to automatically compute the derivative of the model's output function (e.g. gradient descend needs the first order derivative and the Newton method even the second order). Thus, the support for automatic differentiation (autodiff), i.e., evaluating the gradient at a desired coordinate without manually calculating the derivative, is central to any deep learning library that actually wants to support the <b>learning</b> part.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
How it works</h1>
<h2><a class="anchor" id="autotoc_md11"></a>
Mathematical Background</h2>
<dl class="section note"><dt>Note</dt><dd>This section is largely based on an awesome survey by Baydin et al. <a class="el" href="citelist.html#CITEREF_autodiff_survey">[2]</a> . </dd></dl>
<h3><a class="anchor" id="autotoc_md12"></a>
Forward Mode</h3>
<p>In a twist of sheer elegance, consider the following observation. For \(a, b\in\mathbb R\), we call \(z=a+b\varepsilon\) a <em>dual number</em>, where \(\varepsilon \neq 0\) is a new symbol defined such that \(\varepsilon^2 = 0\). We will now use dual numbers to calculate <b>both</b>, the evaluation of the function and the evaluation of its derivative. First, observe that for arbitary dual numbers \(u+\dot u\varepsilon, v+\dot v\varepsilon\) it holds that  </p><p class="formulaDsp">
\begin{align}
    (u+\dot u\varepsilon) + (v+\dot v\varepsilon) &amp;= (u+v) + (\dot u + \dot v)\varepsilon, \text{and}\\
    (u+\dot u\varepsilon) \cdot (v+\dot v\varepsilon) &amp;= uv + (u\dot v + \dot uv)\varepsilon.
\end{align}
</p>
<p> Notice how this expresses the linearity of differentiation and the product rule, if we interpret \(\dot u\) and \(\dot v\) as the derivatives at point \(u\) and \(v\) respectively. Now let \(f\colon \mathbb{R}\to\mathbb{R}\) be a differentiable function. We extend it into the dual numbers via </p><p class="formulaDsp">
\[f(x + \dot x \varepsilon) := f(x) + f&#39;(x)\dot x\varepsilon.\]
</p>
<p> Note that this definition makes sense with our previous interpretation. Further, we can now observe that the chain rule also holds:  </p><p class="formulaDsp">
\begin{align}
    f(g(x + \dot x\varepsilon) &amp;= f(g(x) + g&#39;(x)\dot x\varepsilon))\\
        &amp;= f(g(x)) + f&#39;(g(x))g&#39;(x)\varepsilon.
\end{align}
</p>
<p> Given that this actually holds in general (which it does), we can now simultaneously evaluate \(f(x)\) and \(f&#39;(x)\) by calculating \(f(x+1\varepsilon)\) and taking the real part for \(f(x)\) and the coefficient of \(\varepsilon\) is the result of \(f&#39;(x)\).</p>
<p>But what about functions \(f\colon \mathbb{R}^n \to \mathbb{R}\) with more inputs? Since the forward pass can only calculate the derivative in one direction per pass, we need \(n\) passes to compute the gradient \(\nabla f\), which is quite inefficient and, where the <em>reverse mode</em> automatic differentiation shines.</p>
<h3><a class="anchor" id="autotoc_md13"></a>
Reverse Mode</h3>
<p>Consider the composite function \(h := f\circ g\), the <em>chain rule</em> states that the derivative \(h\) at point \(x\) can be calculated via </p><p class="formulaDsp">
\[\left.\frac{\partial h}{\partial x}\right|_{x} = \left.\frac{\partial f}{\partial u}\right|_{u=g(x)} \cdot \left.\frac{\partial u}{\partial x}\right|_{x}.\]
</p>
<p> This is crucial since it allows us to compute the gradient at a single point without first calculating the first order derivative over all points (as would be done with symbolic differentiation). Instead, we have to overload the semantics of each function to calculate the value (as it usually would) and additionally store the computation information somewhere to allow computing the gradient in the <b>reverse</b> order of the functions. That is, in the example above, the forward pass would first compute \(y = f(x)\), then \(z = g(y)\) and then go backwards and compute the gradients \(\frac{\partial z}{\partial y}\) and then \(\frac{\partial y}{\partial x}\).</p>
<p>This way, we can compute all derivatives at the same time (and thus are <b>more efficient</b> than forward mode) but need to store the intermediate results and the computation order for the backwards pass (and thus are <b>less performant</b> than forward mode).</p>
<h2><a class="anchor" id="autodiffimpl"></a>
Implementation in libdl</h2>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000014">Todo:</a></b></dt><dd>WIP</dd></dl>
<h1><a class="anchor" id="autotoc_md14"></a>
Adding Autodiff Support to a Function</h1>
<p>This example with equip the logarithm, <code><a class="el" href="group__Arithmetic.html#gaf6ac5629058e70cd3bde237b5845d9ad" title="Natural logarithm, .">dl::log(dl::TensorPtr x)</a></code> with support for automatic differentiation. We will start of with the basic stub </p><div class="fragment"><div class="line">TensorPtr <a class="code hl_function" href="group__Arithmetic.html#gaf6ac5629058e70cd3bde237b5845d9ad">dl::log</a>(TensorPtr x) <span class="keyword">noexcept</span> {</div>
<div class="line">    <span class="keyword">auto</span> tensor = x-&gt;log();</div>
<div class="line">    <span class="keywordflow">if</span> (tensor-&gt;requiresGrad()) {</div>
<div class="line">        <span class="comment">/* implement derivative here */</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> tensor;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__Arithmetic_html_gaf6ac5629058e70cd3bde237b5845d9ad"><div class="ttname"><a href="group__Arithmetic.html#gaf6ac5629058e70cd3bde237b5845d9ad">dl::log</a></div><div class="ttdeci">TensorPtr log(TensorPtr x) noexcept</div><div class="ttdoc">Natural logarithm, .</div></div>
</div><!-- fragment --><p> Remember from the <a class="el" href="technicalAutodiff.html#autodiffimpl">description above</a> that, to enable a function for the backwards pass, it only needs to register a callback for calculating the derivative to <code>dl::TensorImpl::gradfn</code>. </p><div class="fragment"><div class="line">tensor-&gt;grad = [x = <a class="code hl_functionRef" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(x)](<a class="code hl_class" href="classdl_1_1TensorPtr.html">dl::TensorPtr</a> agg) {</div>
<div class="line">    <span class="comment">// Compute the gradient</span></div>
<div class="line">    <span class="keyword">auto</span> grad = 1/x;</div>
<div class="line">    <span class="comment">// Update the gradient of x</span></div>
<div class="line">    x-&gt;grad = (x-&gt;grad == <span class="keyword">nullptr</span>)? grad : (x-&gt;grad + grad);</div>
<div class="line">    <span class="comment">// Compute the gradients for the value that x depends on (go one step further back in the chain rule) or, if x is</span></div>
<div class="line">    <span class="comment">// the last element in the chain (i.e., it has no gradfn to go back further), it must require a gradient itself</span></div>
<div class="line">    <span class="keywordflow">if</span> (x-&gt;gradfn)</div>
<div class="line">        x-&gt;gradfn(grad);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        assert(x-&gt;requiresGrad());</div>
<div class="line">};</div>
<div class="ttc" id="aclassdl_1_1TensorPtr_html"><div class="ttname"><a href="classdl_1_1TensorPtr.html">dl::TensorPtr</a></div><div class="ttdoc">The Tensor is a managed pointer to a tensor. It can generally be thought of like an std::unique_ptr&lt;T...</div><div class="ttdef"><b>Definition</b> <a href="tensorptr_8hpp_source.html#l00045">tensorptr.hpp:45</a></div></div>
<div class="ttc" id="amove_html"><div class="ttname"><a href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a></div><div class="ttdeci">T move(T... args)</div></div>
</div><!-- fragment --> <dl class="todo"><dt><b><a class="el" href="todo.html#_todo000015">Todo:</a></b></dt><dd>WIP</dd></dl>
<h2><a class="anchor" id="autotoc_md15"></a>
Functions with Multiple Inputs</h2>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000016">Todo:</a></b></dt><dd>WIP</dd></dl>
<h2><a class="anchor" id="autotoc_md16"></a>
Adding Autodiff to a Function that Composites autodiff enabled functions</h2>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000017">Todo:</a></b></dt><dd>This is not currently supported</dd></dl>
<h1><a class="anchor" id="autotoc_md17"></a>
Gradients</h1>
<h2><a class="anchor" id="autotoc_md18"></a>
Gradients of Matrix Operations</h2>
<h3><a class="anchor" id="autotoc_md19"></a>
Matrix Product</h3>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000018">Todo:</a></b></dt><dd>WIP </dd></dl>
<p class="formulaDsp">
\[\frac{\partial AB}{\partial A} = B^\top\]
</p>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="technicalIdx.html">Technical</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
